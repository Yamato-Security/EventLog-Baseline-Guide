name: Check auditpol settings

on:
  workflow_dispatch:

jobs:
  build:
    strategy:
      matrix:
        os: [ windows-11-arm, windows-2022, windows-2025]
    runs-on: ${{ matrix.os }}
    steps:
      - name: Run auditpol command
        shell: pwsh
        run: |
          $os = '${{ matrix.os }}'
          $auditFile = "AuditpolOutput-$os.txt"
          auditpol /get /category:* | Out-File -FilePath $auditFile -Encoding utf8
          Get-Content $auditFile | Write-Host

      - name: Run registry check script
        shell: pwsh
        run: |
          $os = '${{ matrix.os }}'
          $regFile = "RegistrySettings-$os.csv"

          $registrySettings = @(
              @{Path = "HKLM:\SOFTWARE\Wow6432Node\Policies\Microsoft\Windows\PowerShell\ModuleLogging"; Name = "EnableModuleLogging"; Category = "PowerShell"},
              @{Path = "HKLM:\SOFTWARE\WOW6432Node\Policies\Microsoft\Windows\PowerShell\ScriptBlockLogging"; Name = "EnableScriptBlockLogging"; Category = "PowerShell"},
              @{Path = "HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System\Audit"; Name = "ProcessCreationIncludeCmdLine_Enabled"; Category = "CommandLine"},
              @{Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"; Name = "RestrictSendingNTLMTraffic"; Category = "NTLM"},
              @{Path = "HKLM:\SYSTEM\CurrentControlSet\Control\Lsa\MSV1_0"; Name = "AuditReceivingNTLMTraffic"; Category = "NTLM"},
              @{Path = "HKLM:\SYSTEM\CurrentControlSet\Services\Netlogon\Parameters"; Name = "AuditNTLMInDomain"; Category = "NTLM"}
          )

          $results = @()

          foreach ($setting in $registrySettings) {
              $value = "Not Set"
              $exists = $false

              try {
                  if (Test-Path $setting.Path) {
                      $regValue = Get-ItemProperty -Path $setting.Path -Name $setting.Name -ErrorAction SilentlyContinue
                      if ($regValue) {
                          $value = $regValue.$($setting.Name)
                          $exists = $true
                      }
                  }
              }
              catch {
                  $value = "Error: $_"
              }

              $results += [PSCustomObject]@{
                  Category = $setting.Category
                  Path = $setting.Path
                  Name = $setting.Name
                  Value = $value
                  Exists = $exists
              }
          }

          $results | Export-Csv -Path $regFile -NoTypeInformation -Encoding UTF8
          $results | Format-Table -AutoSize

      - name: Upload auditpol artifact
        uses: actions/upload-artifact@v4
        with:
          name: auditpol-${{ matrix.os }}-${{ github.run_number }}
          path: AuditpolOutput-${{ matrix.os }}.txt
          retention-days: 10

      - name: Upload CSV artifact
        uses: actions/upload-artifact@v4
        with:
          name: registry-settings-${{ matrix.os }}-${{ github.run_number }}
          path: RegistrySettings-${{ matrix.os }}.csv
          retention-days: 10
